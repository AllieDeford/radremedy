{#

macros.html

Contains macros for commonly-generated items (such as resources
and pagination structures).

#}

{% macro render_pagination(pagination) %}
  <div class="pagination">
  Page: 
  {%- for page in pagination.iter_pages() %}
    {% if page %}
      {% if page != pagination.page %}
        <a href="{{ url_for_other_page(page) }}">{{ page }}</a>
      {% else %}
        <strong>{{ page }}</strong>
      {% endif %}
    {% else %}
      <span class="ellipsis">â€¦</span>
    {% endif %}
  {%- endfor %}
  {% if pagination.has_next %}
    <a href="{{ url_for_other_page(pagination.page + 1)}}">
      Next &raquo;</a>
  {% endif %}
  </div>
{% endmacro %}

{% macro rating_text(rating) %}
{% if rating == 5 %}
5 - Very Good Experience
{% elif rating == 4 %}
4 - Good Experience
{% elif rating == 2 %}
2 - Bad Experience
{% elif rating == 1 %}
1 - Very Bad Experience
{% else %}
3 - Neutral Experience
{% endif %}
{% endmacro %}

{% macro render_resource(r) %}
	<h5><a href="{{ url_for('remedy.resource', resource_id=r.id) }}">{{ r.name }}</a></h5>
	<p>
		{{ r.categories|join(', ', attribute='name') }}
	</p>
{% if r.location %}
  <p>
    {{ r.location }}
  </p>
{% endif %}
{% endmacro %}

{#
A macro for including the Google Maps JavaScript library.
#}
{% macro gmaps_script_include() %}
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&amp;libraries=places"></script>
{% endmacro %}

{#
A macro for including the standard RAD Remedy utilities library.
#}
{% macro remedy_script_include() %}
<script src="{{ url_for('static', filename='js/remedy.js') }}"></script>
{% endmacro %}

{#
A macro for generating the appropriate JavaScript to handle an address field
and underlying latitude/longitude fields (and optionally, a location field).

Args:
  foraddress: A boolean indicating if this is for a specific address
    instead of a general region.
  autocomplete: The ID of the address/region field.
  latitude: The ID of the latitude field to update.
  longitude: The ID of the longitude field to update.
  location: The ID of the location field to update with geocoded information. Optional.
#}
{% macro gmaps_script(foraddress, autocomplete, latitude, longitude, location='') %}
<script type="text/javascript">
  $(function () {
    var addrAutoComplete = new google.maps.places.Autocomplete(
      (document.getElementById('{{ autocomplete }}')),
      {
{% if foraddress %}
        types: ['address']
{% else %}
        types: ['(regions)']
{% endif %}
      }
    );
    google.maps.event.addListener(addrAutoComplete, 'place_changed', function() {
      var place = addrAutoComplete.getPlace(),
        valid_place = false,
        location_str = '';

      if( place ) {
        if( place.geometry && place.geometry.location ) {
          $("#{{ latitude }}").val(place.geometry.location.lat().toFixed(5));
          $("#{{ longitude }}").val(place.geometry.location.lng().toFixed(5));
          valid_place = true;
        }
{% if location %}
{# 
Loop through our address components and try to find the city, county,
and state values, from which we will build a location string.
#}
        if( place['address_components'] && place['address_components'].length > 0 ) {
          var city_str = '',
            county_str = '',
            state_str = '';

          components: for(var compIdx = 0; compIdx < place['address_components'].length; compIdx += 1) {
            var addr_comp = place['address_components'][compIdx],
              name_str = '';
{# 
Figure out the name string to use - prefer short_name but
fall back to long_name.
#}
            if( $.trim(addr_comp['short_name']).length > 0 ) {
              name_str = addr_comp['short_name'];
            }
            else if ( $.trim(addr_comp['long_name']).length > 0 ) {
              name_str = addr_comp['long_name'];
            }

            if( name_str.length === 0 ) {
              continue;
            }
{# 
Loop through the different types in this address component - if we
find one we want ("locality" for cities, "administrative_area_level_2"
for counties, "administrative_area_level_1" for states), update the
appropriate string if we do not already have a value defined.
#}
            if ( !addr_comp['types'] || addr_comp['types'].length === 0 ) {
              continue;
            }

            for(var typeIdx = 0; typeIdx < addr_comp['types'].length; typeIdx += 1) {
              var typeName = addr_comp['types'][typeIdx];

              switch (typeName) {
                case 'locality':
                  if( city_str.length === 0 ) {
                    city_str = name_str;
                  }
                  continue components;

                case 'administrative_area_level_2':
                  if( county_str.length === 0 ) {
                    county_str = name_str;
                  }
                  continue components;

                case 'administrative_area_level_1':
                  if( state_str.length === 0 ) {
                    state_str = name_str;
                  }
                  continue components;
              }
            }
          }
{# 
See if we have a city, and fall back to a county if we have that instead.
#}
          if( city_str.length > 0 ) {
            location_str = city_str;
          }
          else if ( county_str.length > 0 ) {
            location_str = county_str;
          }
{# 
Finally, add the state, ensuring to add a comma/space if we already
have a city or county.
#}
          if( state_str.length > 0 ) {
            if (location_str.length > 0 ) {
              location_str += ", ";
            }

            location_str += state_str;
          }
        }
        $("#{{ location }}").val(location_str);
{% endif %}
      }

      if ( valid_place === false ) {
        $("#{{ latitude }}").val('');
        $("#{{ longitude }}").val('');
{% if location %}
        $("#{{ location }}").val('');
{% endif %}
      }
    });
    $("#{{ autocomplete }}").change(function () {
      if( $.trim($(this).val()) == '') {
        $("#{{ latitude }}").val('');
        $("#{{ longitude }}").val('');
{% if location %}
        $("#{{ location }}").val('');
{% endif %}
      }     
    })
  });
</script>
{% endmacro %}

{#
A macro for hiding the control group containing an element.

Args:
  element: The ID of the element whose control group should be hidden.
#}
{% macro hide_control_group(element) %}

<script type="text/javascript">
window.Remedy.hideControlGroup("{{ element }}");
</script>
{% endmacro %}
